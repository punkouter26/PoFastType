@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using PoFastType.Client.Services
@using PoFastType.Shared.Models
@inject IUserService UserService
@inject NavigationManager Navigation
@implements IDisposable

<nav class="navbar navbar-expand-lg navbar-dark retro-navbar">
    <div class="container-fluid">
        <a class="navbar-brand retro-brand" href="/">PoFastType</a>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
          <div class="collapse navbar-collapse" id="navbarNav">            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link retro-nav-link" href="/leaderboard">Leaderboard</a>
                </li>
                @if (isAuthenticated)
                {
                    <li class="nav-item">
                        <a class="nav-link retro-nav-link" href="/stats">My Stats</a>
                    </li>
                }
            </ul>
              <ul class="navbar-nav">
                @if (isAuthenticated)
                {
                    <li class="nav-item">
                        <span class="navbar-text me-3">
                            @if (isRealUser)
                            {
                                <div class="text-end">
                                    <div class="fw-bold">@username</div>
                                    @if (!string.IsNullOrEmpty(userEmail))
                                    {
                                        <small class="text-muted">@userEmail</small>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-end">
                                    <span class="fw-bold text-muted">Playing as @username</span>
                                    <small class="d-block text-muted">Anonymous Session</small>
                                </div>
                            }
                        </span>
                    </li>
                    @if (isRealUser)
                    {
                        <li class="nav-item">
                            <button class="btn btn-outline-light btn-sm" @onclick="SignOut">Sign Out</button>
                        </li>
                    }
                    else
                    {
                        <li class="nav-item">
                            <button class="btn btn-primary btn-sm" @onclick="SignIn">Sign In</button>
                        </li>
                    }
                }
                else
                {
                    <li class="nav-item">
                        <button class="btn btn-primary btn-sm" @onclick="SignIn">Sign In</button>
                    </li>
                }
            </ul>
        </div>
    </div>
</nav>

@code {
    private bool isAuthenticated = false;
    private bool isRealUser = false;
    private string username = "User";
    private string userEmail = "";protected override async Task OnInitializedAsync()
    {
        await CheckAuthentication();
        
        // Listen for navigation events to refresh auth state when user returns from login
        Navigation.LocationChanged += OnLocationChanged;
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Refresh authentication state when navigation occurs
        await CheckAuthentication();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }    private async Task CheckAuthentication()
    {
        try
        {
            isAuthenticated = await UserService.IsAuthenticatedAsync();
            isRealUser = await UserService.IsRealUserAsync();
            
            if (isAuthenticated)
            {
                var userProfile = await UserService.GetCurrentUserAsync();
                if (userProfile != null)
                {
                    username = !string.IsNullOrEmpty(userProfile.Username) ? userProfile.Username : "User";
                    userEmail = userProfile.Email ?? "";
                }
                else
                {
                    // Fallback to basic user info if profile service fails
                    username = "User";
                    userEmail = "";
                    
                    // Log for debugging
                    Console.WriteLine("Failed to get user profile from service");
                }
            }
            else
            {
                username = "User";
                userEmail = "";
                isRealUser = false;
            }
            
            StateHasChanged(); // Ensure UI updates
        }
        catch (Exception ex)
        {
            isAuthenticated = false;
            isRealUser = false;
            username = "User";
            userEmail = "";
            
            // Log for debugging
            Console.WriteLine($"Error in CheckAuthentication: {ex.Message}");
        }
    }private void SignIn()
    {
        // Redirect to Azure Easy Auth login endpoint
        Navigation.NavigateTo("/.auth/login/aad", forceLoad: true);
    }    private void SignOut()
    {
        // Clear the user cache before logout
        UserService.ClearCache();
        
        // Redirect to Azure Easy Auth logout endpoint with return URL
        var returnUrl = Navigation.BaseUri;
        Navigation.NavigateTo($"/.auth/logout?post_logout_redirect_uri={Uri.EscapeDataString(returnUrl)}", forceLoad: true);
    }
}
