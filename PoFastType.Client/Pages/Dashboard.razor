@page "/dashboard"
@using PoFastType.Shared.Models
@inject HttpClient Http
@inject ILogger<Dashboard> Logger
@inject NavigationManager NavigationManager
@inject GameStateService GameState
@implements IDisposable

<PageTitle>PoFastType - Dashboard</PageTitle>

<div class="container mt-4">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading your dashboard...</p>
        </div>
    }
    else if (error != null)
    {
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Error Loading Dashboard</h4>
            <p>@error</p>
            <button class="btn btn-outline-danger" @onclick="LoadDashboard">Try Again</button>
        </div>
    }
    else
    {
        <!-- Welcome Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h2>Welcome back, @userProfile?.Username!</h2>
                        <p class="mb-0">Ready to improve your typing speed? Let's get started!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-primary">@userProfile?.TotalTestsCompleted</h3>
                        <p class="card-text">Tests Completed</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-success">@userProfile?.BestNetWPM.ToString("F1")</h3>
                        <p class="card-text">Best Net WPM</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-info">@userProfile?.AverageNetWPM.ToString("F1")</h3>
                        <p class="card-text">Average Net WPM</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-warning">@userProfile?.AverageAccuracy.ToString("F1")%</h3>
                        <p class="card-text">Average Accuracy</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Quick Actions</h5>
                        <div class="d-flex justify-content-center gap-3">
                            <a href="/" class="btn btn-primary btn-lg">
                                <i class="bi bi-play-circle"></i> Start New Test
                            </a>
                            <a href="/stats" class="btn btn-outline-primary btn-lg">
                                <i class="bi bi-graph-up"></i> View Detailed Stats
                            </a>
                            <a href="/leaderboard" class="btn btn-outline-success btn-lg">
                                <i class="bi bi-trophy"></i> Leaderboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        @if (recentScores.Any())
        {
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Recent Activity</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th class="text-center">Net WPM</th>
                                            <th class="text-center">Accuracy</th>
                                            <th class="text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var score in recentScores.Take(5))
                                        {
                                            <tr>
                                                <td>
                                                    <small>@score.Timestamp.ToString("MMM dd, yyyy HH:mm")</small>
                                                </td>
                                                <td class="text-center">
                                                    <span class="fw-bold @(score.NetWPM >= 40 ? "text-success" : score.NetWPM >= 30 ? "text-warning" : "text-danger")">
                                                        @score.NetWPM.ToString("F1")
                                                    </span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="@(score.Accuracy >= 95 ? "text-success" : score.Accuracy >= 90 ? "text-warning" : "text-danger")">
                                                        @score.Accuracy.ToString("F1")%
                                                    </span>
                                                </td>
                                                <td class="text-center">
                                                    @if (score.NetWPM >= 40 && score.Accuracy >= 95)
                                                    {
                                                        <span class="badge bg-success">Excellent</span>
                                                    }
                                                    else if (score.NetWPM >= 30 && score.Accuracy >= 90)
                                                    {
                                                        <span class="badge bg-warning text-dark">Good</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">Practice</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5>No tests completed yet!</h5>
                            <p class="text-muted">Complete your first typing test to see your progress here.</p>
                            <a href="/" class="btn btn-primary">Start Your First Test</a>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {    private UserProfile? userProfile;
    private List<UserGameResult> recentScores = new();
    private bool isLoading = true;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboard();
        
        // Subscribe to game state updates
        GameState.UserStatsRefreshRequested += OnUserStatsRefreshRequested;
    }

    public void Dispose()
    {
        // Unsubscribe from game state updates
        GameState.UserStatsRefreshRequested -= OnUserStatsRefreshRequested;    }

    private async void OnUserStatsRefreshRequested()
    {
        await LoadDashboard();
        StateHasChanged();
    }

    private async Task LoadDashboard()
    {
        try
        {
            isLoading = true;
            error = null;

            // Load user profile
            var profileResponse = await Http.GetAsync("api/user/profile");
            if (profileResponse.IsSuccessStatusCode)
            {
                userProfile = await profileResponse.Content.ReadFromJsonAsync<UserProfile>();
            }

            // Load recent scores
            var scoresResponse = await Http.GetAsync("api/scores/me/stats");
            if (scoresResponse.IsSuccessStatusCode)
            {
                recentScores = await scoresResponse.Content.ReadFromJsonAsync<List<UserGameResult>>() ?? new();
            }

            Logger.LogInformation("Dashboard loaded for user");
        }
        catch (Exception ex)
        {
            error = "An error occurred while loading your dashboard.";
            Logger.LogError(ex, "Error loading dashboard");
        }
        finally
        {
            isLoading = false;
        }
    }    public class UserGameResult
    {
        public double NetWPM { get; set; }
        public double Accuracy { get; set; }
        public double GrossWPM { get; set; }
        public string ProblemKeysJson { get; set; } = string.Empty;
        public DateTime Timestamp { get; set; }
    }
} 