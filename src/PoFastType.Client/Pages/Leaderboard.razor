@page "/leaderboard"
@inject HttpClient Http
@inject ILogger<Leaderboard> Logger
@inject GameStateService GameState
@using PoFastType.Shared.Models
@implements IDisposable

<PageTitle>PoFastType - Leaderboard</PageTitle>

<div class="game-container page-content">
    <div class="row">
        <div class="col-12">
            <div class="card retro-card">
                <div class="card-header retro-card-header">
                    <h3 class="mb-0">Global Leaderboard</h3>
                </div>
                <div class="card-body">
                    @if (isLoading)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (error != null)
                    {
                        <div class="alert alert-danger" role="alert">
                            <h4 class="alert-heading">Error Loading Leaderboard</h4>
                            <p>@error</p>
                        </div>
                    }
                    else if (!leaderboardEntries.Any())
                    {
                        <div class="text-center py-5">
                            <h4 class="text-muted">No scores yet</h4>
                            <a href="/" class="btn btn-primary">Start Typing</a>
                        </div>
                    }
                    else
                    {
                        <RadzenDataGrid Data="@leaderboardEntries" TItem="LeaderboardEntry" 
                                       AllowSorting="true" AllowFiltering="true" AllowPaging="true" 
                                       PageSize="10" PagerHorizontalAlign="HorizontalAlign.Center"
                                       FilterMode="FilterMode.Simple"
                                       GridLines="DataGridGridLines.Horizontal">
                            <Columns>
                                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="Rank" Title="Rank" Width="100px" Sortable="false">
                                    <Template Context="entry">
                                        @if (entry.Rank == 1)
                                        {
                                            <span class="leaderboard-rank rank-1 fs-6">ðŸ¥‡ @entry.Rank</span>
                                        }
                                        else if (entry.Rank == 2)
                                        {
                                            <span class="leaderboard-rank rank-2 fs-6">ðŸ¥ˆ @entry.Rank</span>
                                        }
                                        else if (entry.Rank == 3)
                                        {
                                            <span class="leaderboard-rank rank-3 fs-6">ðŸ¥‰ @entry.Rank</span>
                                        }
                                        else
                                        {
                                            <span class="leaderboard-rank">@entry.Rank</span>
                                        }
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="Username" Title="Player" />
                                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="CompositeScore" Title="Score" Width="120px" TextAlign="TextAlign.Center">
                                    <Template Context="entry">
                                        <span class="fs-5 fw-bold text-warning">@entry.CompositeScore.ToString("F0")</span>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="GrossWPM" Title="Gross WPM" Width="120px" TextAlign="TextAlign.Center" FormatString="{0:F1}" />
                                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="Accuracy" Title="Accuracy" Width="120px" TextAlign="TextAlign.Center">
                                    <Template Context="entry">
                                        <span>@entry.Accuracy.ToString("F1")%</span>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="Timestamp" Title="Date" Width="140px" TextAlign="TextAlign.End">
                                    <Template Context="entry">
                                        <small class="text-muted">@entry.Timestamp.ToString("MMM dd, yyyy")</small>
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                        
                        <div class="text-center mt-4">
                            <button class="btn btn-outline-primary" @onclick="LoadLeaderboard">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<LeaderboardEntry> leaderboardEntries = new();
    private bool isLoading = true;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        await LoadLeaderboard();
        
        // Subscribe to game state updates
        GameState.LeaderboardRefreshRequested += OnLeaderboardRefreshRequested;
    }

    public void Dispose()
    {
        // Unsubscribe from game state updates
        GameState.LeaderboardRefreshRequested -= OnLeaderboardRefreshRequested;
    }

    private async void OnLeaderboardRefreshRequested()
    {
        await LoadLeaderboard();
        StateHasChanged();
    }

    private async Task LoadLeaderboard()
    {
        try
        {
            isLoading = true;
            error = null;
            
            var response = await Http.GetAsync("api/scores/leaderboard?top=10");
            
            if (response.IsSuccessStatusCode)
            {
                leaderboardEntries = await response.Content.ReadFromJsonAsync<List<LeaderboardEntry>>() ?? new();
                Logger.LogInformation("Loaded leaderboard with {Count} entries", leaderboardEntries.Count);
            }
            else
            {
                error = $"Failed to load leaderboard: {response.StatusCode}";
                Logger.LogWarning("Failed to load leaderboard: {StatusCode}", response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            error = "An error occurred while loading the leaderboard.";
            Logger.LogError(ex, "Error loading leaderboard");
        }
        finally
        {
            isLoading = false;
        }
    }
} 