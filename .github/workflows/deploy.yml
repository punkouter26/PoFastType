name: Deploy PoFastType to Azure

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: 'pofasttype-app'
  AZURE_WEBAPP_PACKAGE_PATH: './publish'
  DOTNET_VERSION: '9.x'
  NODE_VERSION: '20.x'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Restore dependencies
      run: dotnet restore PoFastType.sln

    - name: Build solution
      run: dotnet build PoFastType.sln --configuration Release --no-restore

    - name: Run unit tests
      run: dotnet test PoFastType.Tests/PoFastType.Tests.csproj --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage"

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          **/TestResults/
          **/coverage.cobertura.xml

    - name: Publish application
      run: dotnet publish PoFastType.Api/PoFastType.Api.csproj --configuration Release --output ${{ env.AZURE_WEBAPP_PACKAGE_PATH }} --no-build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webapp-build
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production
    
    outputs:
      webapp-name: ${{ steps.deploy-infra.outputs.webAppName }}
      resource-group: ${{ steps.deploy-infra.outputs.resourceGroupName }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure CLI Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Infrastructure with Bicep
      id: deploy-infra
      run: |
        # Set variables
        RESOURCE_GROUP="rg-pofasttype-prod"
        LOCATION="East US"
        APP_NAME="pofasttype-app-$(date +%s)"
        
        # Create resource group if it doesn't exist
        az group create --name $RESOURCE_GROUP --location "$LOCATION"
        
        # Deploy infrastructure using Bicep (we'll create this in the next step)
        DEPLOYMENT_OUTPUT=$(az deployment group create \
          --resource-group $RESOURCE_GROUP \
          --template-file ./infra/main.bicep \
          --parameters \
            appName=$APP_NAME \
            environment=prod \
            location="$LOCATION" \
          --output json)
        
        # Extract outputs
        WEB_APP_NAME=$(echo $DEPLOYMENT_OUTPUT | jq -r '.properties.outputs.webAppName.value')
        
        echo "webAppName=$WEB_APP_NAME" >> $GITHUB_OUTPUT
        echo "resourceGroupName=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
        
        echo "Deployed infrastructure:"
        echo "  Resource Group: $RESOURCE_GROUP"
        echo "  Web App Name: $WEB_APP_NAME"

  deploy-application:
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-infrastructure]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: webapp-build
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

    - name: Azure CLI Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ needs.deploy-infrastructure.outputs.webapp-name }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

    - name: Configure App Settings
      run: |
        # Configure application settings for production
        az webapp config appsettings set \
          --resource-group ${{ needs.deploy-infrastructure.outputs.resource-group }} \
          --name ${{ needs.deploy-infrastructure.outputs.webapp-name }} \
          --settings \
            "ASPNETCORE_ENVIRONMENT=Production" \
            "AzureTableStorage__ConnectionString=${{ secrets.AZURE_TABLE_STORAGE_CONNECTION_STRING }}" \
            "AzureTableStorage__TableName=PoFastTypeGameResults" \
            "Logging__LogLevel__Default=Information" \
            "Logging__LogLevel__Microsoft.AspNetCore=Warning"

    - name: Restart Web App
      run: |
        az webapp restart \
          --resource-group ${{ needs.deploy-infrastructure.outputs.resource-group }} \
          --name ${{ needs.deploy-infrastructure.outputs.webapp-name }}

    - name: Health Check
      run: |
        # Wait for app to restart
        sleep 30
        
        # Get the default domain
        WEB_APP_URL=$(az webapp show \
          --resource-group ${{ needs.deploy-infrastructure.outputs.resource-group }} \
          --name ${{ needs.deploy-infrastructure.outputs.webapp-name }} \
          --query defaultHostName -o tsv)
        
        echo "Application URL: https://$WEB_APP_URL"
        
        # Perform health check
        for i in {1..10}; do
          if curl -f -s "https://$WEB_APP_URL/api/diag/health" > /dev/null; then
            echo "‚úÖ Health check passed"
            break
          else
            echo "‚è≥ Health check attempt $i failed, retrying in 10s..."
            sleep 10
          fi
        done

  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'pull_request'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: webapp-build
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

    - name: Azure CLI Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Staging Slot
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        slot-name: staging
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

    - name: Configure Staging App Settings
      run: |
        az webapp config appsettings set \
          --resource-group rg-pofasttype-prod \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --slot staging \
          --settings \
            "ASPNETCORE_ENVIRONMENT=Staging" \
            "AzureTableStorage__ConnectionString=${{ secrets.AZURE_TABLE_STORAGE_CONNECTION_STRING }}" \
            "AzureTableStorage__TableName=PoFastTypeGameResultsStaging"

    - name: Comment PR with staging URL
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `üöÄ **Staging Deployment Complete**
            
            Your PR has been deployed to staging:
            - **URL**: https://${{ env.AZURE_WEBAPP_NAME }}-staging.azurewebsites.net
            - **Health Check**: https://${{ env.AZURE_WEBAPP_NAME }}-staging.azurewebsites.net/api/diag/health
            
            Please test your changes before merging.`
          })
